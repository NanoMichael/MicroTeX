name: Ubuntu

on:
  push:
    branches:
      - master
      - openmath
      - wasm
  pull_request:
    branches:
      - master
      - openmath

jobs:
  build_by_meson:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: Downloading dependencies 📥
        run: |
          sudo apt-get install build-essential meson libgtksourceviewmm-3.0-dev libgtkmm-3.0-dev
          sudo apt-get install qt5-default qttools5-dev-tools
      - name: Configure 🔧
        run: meson _build
      - name: Compile 🎲
        run: ninja -C _build
      - name: Compress build artifacts 📦
        run: |
          pushd _build
          tar -c * | zstd -o $GITHUB_WORKSPACE/artifacts.tar.zst
          popd
      - name: Upload build artifacts 📤
        uses: actions/upload-artifact@v1
        with:
          name: Build artifacts
          path: artifacts.tar.zst

  build_by_cmake:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-20.04
    steps:
      - name: Downloading Source Code 📥
        uses: actions/checkout@v2
      - name: Downloading dependencies 📥
        run: |
          sudo apt-get install build-essential meson libgtksourceviewmm-3.0-dev libgtkmm-3.0-dev
          sudo apt-get install qt5-default qttools5-dev-tools
      - name: Configure 🔧
        run: |
          cd ${{ github.workspace }}
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DGTK=ON -DBUILD_EXAMPLE_GTK=ON -DQT=ON -DBUILD_EXAMPLE_QT=ON -DBUILD_EXAMPLE_QTPNG=ON -DBUILD_EXAMPLE_MEMCHECK=ON -DWASM=OFF -DHAVE_LOG=ON -G Ninja
      - name: Compile 🎲
        run: |
          cd ${{ github.workspace }}
          cd build
          ninja

  build_wasm:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-20.04
    steps:
      - name: Downloading Source Code 📥
        uses: actions/checkout@v2
      - name: Setup Emscripten Environment 🍺
        uses: mymindstorm/setup-emsdk@v11
      - name: Verify Emscripten 🚀
        run: emcc -v
      - name: Compile 🎲
        run: |
          cd ${{ github.workspace }}
          cd platform/wasm/web
          npm install
          npm run build:lib && npm run build:demo
